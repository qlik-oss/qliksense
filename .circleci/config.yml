version: 2.0
jobs:
  push:
    docker:
      - image: qlik/elastic-charts-build-tools
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - attach_workspace:
          at: ~/
      - checkout
      - run:
          name: Push
          command: |
            LATEST_VERSION=$(jfrog bt vs qlik/edge/qsefe  --key $RT_APIKEY --user dtg@qlik | jq ".name" | sed 's/"//g')
            CURRENT_VERSION=$(yq r transformers/qseokversion.yaml 'patches[0].patch' | grep "chartVersion" | sed 's/\chartVersion: //g')

            # LATEST_VERSION=$(echo $LATEST_VERSION | sed 's/"//g')
            vert ">$LATEST_VERSION" $CURRENT_VERSION || ret=$?

            if [ $ret -ne 0 ]; then
              echo "DO A PR"
              git config --global user.email "qlikossbuild@qlik.com"
              git config --global user.name "qlikossbuild"

              export GITHUB_TOKEN=${GITHUB_API_TOKEN}

              git checkout -b update/edge-chart


              git commit -am "[tag update] Update Image tag to ${CIRCLE_BRANCH}"

              hub pull-request -f -m "${SERVICE_NAME}: Staging Integration" --base master





            else
              echo "DON'T DO ANYTHING"
            fi


workflows:
  version: 2
  publish:
    jobs:
      - push

#  namespace-cleanup:
#    jobs:
#      - openshift-namespace-cleanup
#    triggers:
#      - schedule:
#          cron: "0 * * * *"
#          filters:
#            branches:
#              only:
#                - master

# Avoid non-master slack noise
experimental:
  notify:
    branches:
      only:
        - master
