version: 2.0
jobs:
  push:
    docker:
      - image: qlik/elastic-charts-build-tools
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - attach_workspace:
          at: ~/
      - checkout
      - run:
          name: Push
          command: |
            LATEST_VERSION=$(jfrog bt vs qlik/edge/qsefe  --key $RT_APIKEY --user dtg@qlik | jq ".name")
            CURRENT_VERSION=$(yq r transformers/qseokversion.yaml 'patches[0].patch' | grep "chartVersion" | sed 's/\chartVersion: //g')

            vert ">LATEST_VERSION" $CURRENT_VERSION
            ret=$?

            if [ $ret -ne 0 ]; then
              echo "DO A PR"
            else
              echo "DON'T DO ANYTHING"
            fi


workflows:
  version: 2
  publish:
    jobs:
      - push

#  namespace-cleanup:
#    jobs:
#      - openshift-namespace-cleanup
#    triggers:
#      - schedule:
#          cron: "0 * * * *"
#          filters:
#            branches:
#              only:
#                - master

# Avoid non-master slack noise
experimental:
  notify:
    branches:
      only:
        - master
