version: 2.0
jobs:
  push:
    docker:
      - image: qlik/elastic-charts-build-tools
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - attach_workspace:
          at: ~/
      - checkout
      - run:
          name: Push
          command: |
            apk add --no-cache
            mkdir hub && \
                wget https://github.com/github/hub/releases/download/v2.12.2/hub-linux-amd64-2.12.2.tgz -O- | \
                tar xz --strip-components 1 --directory hub \
                && ./hub/install \
                && rm -r hub

            LATEST_VERSION=$(jfrog bt vs qlik/edge/qsefe  --key $RT_APIKEY --user dtg@qlik | jq ".name" | sed 's/"//g')
            CURRENT_VERSION=$(yq r transformers/qseokversion.yaml 'patches[0].patch' | grep "chartVersion" | sed 's/\chartVersion: //g')

            # LATEST_VERSION=$(echo $LATEST_VERSION | sed 's/"//g')
            vert ">$LATEST_VERSION" $CURRENT_VERSION || ret=$?

            if [ $ret -ne 0 ]; then
              echo "DO A PR"
              git config --global user.email "qlikossbuild@qlik.com"
              git config --global user.name "qlikossbuild"

              export GITHUB_API_TOKEN=${GITHUB_TOKEN}
              CLONE_URL=https://${GITHUB_API_TOKEN}@github.com/qlik-oss/qliksense-k8s && git clone ${CLONE_URL}

              # git checkout testing-ci && git checkout -b update/edge

              git commit -am "[tag update] Update Image tag to ${CIRCLE_BRANCH}" && git push origin update/edge

              hub pull-request -f -m "${SERVICE_NAME}: Staging Integration" --base master
            else
              echo "DON'T DO ANYTHING"
            fi


workflows:
  version: 2
  publish:
    jobs:
      - push

#  namespace-cleanup:
#    jobs:
#      - openshift-namespace-cleanup
#    triggers:
#      - schedule:
#          cron: "0 * * * *"
#          filters:
#            branches:
#              only:
#                - master

# Avoid non-master slack noise
experimental:
  notify:
    branches:
      only:
        - master
